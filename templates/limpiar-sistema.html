<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limpiar Sistema - Proveedores</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../static/CSS/styles.css">
</head>
<body>
    <div class="container mt-4">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h1 class="h4 mb-0">üßπ Limpiar Sistema - Empezar de Cero</h1>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Esta herramienta eliminar√° todos los datos locales para que puedas empezar limpio.
                </div>

                <div id="estadoActual" class="mb-4">
                    <h5>üìä Estado Actual:</h5>
                    <div id="datosActuales">Cargando...</div>
                </div>

                <div class="d-flex gap-2 flex-wrap">
                            '<a href="configuracion-github.html" class="btn btn-warning me-2">Configurar GitHub</a>' +idth, initial-scale=1.0">
    <title>Limpiar Sistema - Proveedores</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../static/CSS/styles.css">
</head>
<body>
    <div class="container mt-4">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h1 class="h4 mb-0">üßπ Limpiar Sistema - Empezar de Cero</h1>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Esta herramienta eliminar√° todos los datos locales para que puedas empezar limpio.
                </div>

                <div id="estadoActual" class="mb-4">
                    <h5>üìä Estado Actual:</h5>
                    <div id="datosActuales">Cargando...</div>
                </div>
                
                <div id="estadoActual" class="mb-4">
                    <h5>√∞≈∏‚Äú≈† Estado Actual:</h5>
                    <div id="datosActuales">Cargando...</div>
                </div>
                
                <div class="d-grid gap-2">
                    <button id="btnLimpiezaNuclear" class="btn btn-danger btn-lg">
                        <i class="bi bi-nuclear"></i> LIMPIEZA NUCLEAR - Borrar TODO
                    </button>
                    <button id="btnLimpiarTodo" class="btn btn-warning btn-lg">
                        <i class="bi bi-trash"></i> Limpiar datos (conservar GitHub)
                    </button>
                    <button id="btnLimpiarSoloProveedores" class="btn btn-info">
                        <i class="bi bi-people"></i> Limpiar solo proveedores
                    </button>
                    <button id="btnVerEstado" class="btn btn-outline-secondary">
                        <i class="bi bi-search"></i> Ver estado actual
                    </button>
                </div>
                
                <hr>
                
                <div id="resultado" class="mt-3"></div>
                
                <div class="mt-4">
                    <h6>üöÄ Despu√©s de limpiar:</h6>
                    <ol>
                        <li>Ve a la <a href="../index.html" target="_blank">p√°gina principal</a></li>
                        <li>Agrega tus proveedores reales</li>
                        <li>Sube los PDFs de contratos</li>
                        <li>Luego migra todo a GitHub</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <script src="../static/js/storage.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            mostrarEstadoActual();
            configurarEventos();
        });
        
        function configurarEventos() {
            document.getElementById('btnLimpiezaNuclear').addEventListener('click', limpiezaNuclear);
            document.getElementById('btnLimpiarTodo').addEventListener('click', limpiarTodo);
            document.getElementById('btnLimpiarSoloProveedores').addEventListener('click', limpiarSoloProveedores);
            document.getElementById('btnVerEstado').addEventListener('click', mostrarEstadoActual);
        }
        
        function limpiezaNuclear() {
            if (!confirm('üö® ADVERTENCIA: Esto eliminar√° ABSOLUTAMENTE TODO incluyendo la configuraci√≥n de GitHub. ¬øContinuar?')) {
                return;
            }
            
            if (!confirm('√∞≈∏‚Äô‚Ç¨ CONFIRMACI√É‚ÄúN FINAL: Se borrar√É¬° TODO sin excepci√É¬≥n. Tendr√É¬°s que reconfigurar GitHub. √Ç¬øProceder?')) {
                return;
            }
            
            try {
                // Mostrar progreso
                document.getElementById('resultado').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> <strong>LIMPIEZA NUCLEAR EN PROGRESO...</strong>
                        <br>Eliminando ABSOLUTAMENTE TODO...
                    </div>
                `;
                
                // BORRAR TODO SIN EXCEPCIONES
                localStorage.clear();
                sessionStorage.clear();
                
                // Eliminar cookies del dominio (si las hay)
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
                
                // Reinicializar completamente vac√≠o
                localStorage.setItem('proveedores', JSON.stringify([]));
                localStorage.setItem('contadorProveedores', '0');
                
                setTimeout(() => {
                    document.getElementById('resultado').innerHTML = `
                        <div class="alert alert-success border-2 border-success">
                            <i class="bi bi-check-circle"></i> 
                            <strong>√∞≈∏¬ß¬π LIMPIEZA NUCLEAR COMPLETADA</strong>
                            <br>El sistema est√É¬° 100% limpio. TODO fue eliminado.
                            <br><br>
                            <div class="alert alert-warning">
                                <strong>√¢≈°¬†√Ø¬∏¬è Siguiente paso:</strong> Reconfigura GitHub si lo necesitas
                            </div>
                            <button onclick="window.location.reload()" class="btn btn-info me-2">Refrescar p√É¬°gina</button>
                            <a href="configuracion-github.html" class="btn btn-warning me-2">Configurar GitHub</a>
                            <a href="../index.html" class="btn btn-primary">Empezar de cero</a>
                        </div>
                    `;
                    
                    // Actualizar estado
                    mostrarEstadoActual();
                }, 2000);
                
            } catch (error) {
                document.getElementById('resultado').innerHTML = `<div class="alert alert-danger">√¢¬ù≈í Error en limpieza nuclear: ${error.message}</div>`;
            }
        }
        
        function mostrarEstadoActual() {
            try {
                const proveedores = obtenerProveedores();
                const keys = Object.keys(localStorage);
                
                let html = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h3 class="text-primary">${proveedores.length}</h3>
                                    <p class="mb-0">Proveedores</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h3 class="text-info">${keys.length}</h3>
                                    <p class="mb-0">Claves en localStorage</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h3 class="text-success">${contarArchivos(proveedores)}</h3>
                                    <p class="mb-0">Archivos PDF</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                if (proveedores.length > 0) {
                    html += '<div class="mt-3"><h6>√∞≈∏‚Äò¬• Proveedores encontrados:</h6><ul class="list-group">';
                    proveedores.forEach(proveedor => {
                        const contratos = proveedor.contratos ? proveedor.contratos.length : 0;
                        const constancia = proveedor.constanciaData ? '√¢≈ì‚Ä¶' : '√¢¬ù≈í';
                        html += `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${proveedor.nombre}</strong>
                                    <br><small class="text-muted">ID: ${proveedor.id}</small>
                                </div>
                                <div>
                                    <span class="badge bg-primary rounded-pill">${contratos} contratos</span>
                                    <span class="badge bg-secondary rounded-pill">Constancia: ${constancia}</span>
                                </div>
                            </li>
                        `;
                    });
                    html += '</ul></div>';
                }
                
                // Mostrar todas las claves de localStorage
                html += '<div class="mt-3"><h6>√∞≈∏‚Äù‚Äò Datos en localStorage:</h6>';
                html += '<div class="accordion" id="accordionLocalStorage">';
                keys.forEach((key, index) => {
                    const value = localStorage.getItem(key);
                    const preview = value ? value.substring(0, 100) : 'null';
                    html += `
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading${index}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                                    <strong>${key}</strong> <span class="text-muted ms-2">(${value ? value.length : 0} caracteres)</span>
                                </button>
                            </h2>
                            <div id="collapse${index}" class="accordion-collapse collapse" data-bs-parent="#accordionLocalStorage">
                                <div class="accordion-body">
                                    <small class="text-muted">${preview}${value && value.length > 100 ? '...' : ''}</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div></div>';
                
                document.getElementById('datosActuales').innerHTML = html;
                
            } catch (error) {
                document.getElementById('datosActuales').innerHTML = `<div class="alert alert-danger">√¢¬ù≈í Error: ${error.message}</div>`;
            }
        }
        
        function contarArchivos(proveedores) {
            let total = 0;
            proveedores.forEach(proveedor => {
                if (proveedor.constanciaData) total++;
                if (proveedor.contratos) {
                    proveedor.contratos.forEach(contrato => {
                        if (contrato.documentoData) total++;
                    });
                }
            });
            return total;
        }
        
        function limpiarTodo() {
            if (!confirm('√¢≈°¬†√Ø¬∏¬è √Ç¬øEst√É¬°s seguro de que quieres ELIMINAR TODOS los datos? Esta acci√É¬≥n no se puede deshacer.')) {
                return;
            }
            
            if (!confirm('√∞≈∏≈°¬® √É≈°LTIMA CONFIRMACI√É‚ÄúN: Se eliminar√É¬°n TODOS los proveedores, contratos y archivos. √Ç¬øContinuar?')) {
                return;
            }
            
            try {
                // Mostrar progreso
                document.getElementById('resultado').innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-hourglass-split"></i> Limpiando sistema...
                    </div>
                `;
                
                // Guardar configuraci√≥n de GitHub si existe
                const configGitHub = localStorage.getItem('github_config');
                
                // LIMPIEZA AGRESIVA - Eliminar todas las claves posibles
                const keysToRemove = [
                    'proveedores',
                    'contadorProveedores', 
                    'contador_proveedores',
                    'proveedores_data',
                    'contratos',
                    'constancias',
                    'archivos',
                    'uploads',
                    'documentos',
                    'ultima_sincronizacion',
                    'ultima_migracion_github',
                    'migracion_completa',
                    'cache_proveedores',
                    'backup_proveedores'
                ];
                
                // Eliminar claves espec√É¬≠ficas
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                    sessionStorage.removeItem(key); // Tambi√É¬©n sessionStorage
                });
                
                // Limpiar todo localStorage EXCEPTO GitHub config
                const allKeys = Object.keys(localStorage);
                allKeys.forEach(key => {
                    if (key !== 'github_config') {
                        localStorage.removeItem(key);
                    }
                });
                
                // Tambi√É¬©n limpiar sessionStorage
                sessionStorage.clear();
                
                // Reinicializar con arrays vac√≠os
                localStorage.setItem('proveedores', JSON.stringify([]));
                localStorage.setItem('contadorProveedores', '0');
                
                // Restaurar configuraci√≥n de GitHub
                if (configGitHub) {
                    localStorage.setItem('github_config', configGitHub);
                }
                
                // Forzar recarga para asegurar limpieza
                setTimeout(() => {
                    document.getElementById('resultado').innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i> 
                            <strong>√¢≈ì‚Ä¶ Sistema completamente limpiado</strong>
                            <br>Se eliminaron TODOS los datos. El sistema est√É¬° limpio.
                            <br><br>
                            <button onclick="window.location.reload()" class="btn btn-info me-2">Refrescar p√É¬°gina</button>
                            <a href="../index.html" class="btn btn-primary">Ir a la p√É¬°gina principal</a>
                        </div>
                    `;
                    
                    // Actualizar estado
                    mostrarEstadoActual();
                }, 1000);
                
            } catch (error) {
                document.getElementById('resultado').innerHTML = `<div class="alert alert-danger">√¢¬ù≈í Error al limpiar: ${error.message}</div>`;
            }
        }
        
        function limpiarSoloProveedores() {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar solo los proveedores y sus datos?')) {
                return;
            }
            
            try {
                // Eliminar solo datos de proveedores
                localStorage.removeItem('proveedores');
                localStorage.removeItem('contadorProveedores');
                localStorage.removeItem('ultima_sincronizacion');
                localStorage.removeItem('ultima_migracion_github');
                localStorage.removeItem('migracion_completa');
                
                // Reinicializar
                localStorage.setItem('proveedores', JSON.stringify([]));
                
                document.getElementById('resultado').innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> 
                        <strong>√¢≈ì‚Ä¶ Proveedores eliminados</strong>
                        <br>Se eliminaron todos los proveedores. La configuraci√≥n se conserv√≥.
                        <br><br>
                        <a href="../index.html" class="btn btn-primary">Agregar nuevos proveedores</a>
                    </div>
                `;
                
                // Actualizar estado
                setTimeout(mostrarEstadoActual, 1000);
                
            } catch (error) {
                document.getElementById('resultado').innerHTML = `<div class="alert alert-danger">√¢¬ù≈í Error: ${error.message}</div>`;
            }
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

